<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>Gridea</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta name="description" content="温故而知新"/>
<meta name="keywords" content="温故而知新"/>

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
<link rel="shortcut icon" href="https://x1hy9.github.io/favicon.ico">

<link rel="stylesheet" href="https://x1hy9.github.io/styles/main.css">

<!-- Modernizr JS -->
<script src="https://x1hy9.github.io/media/scripts/modernizr-2.6.2.min.js"></script>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
<scripts src="https://x1hy9.github.io/media/scripts/respond.min.js"></scripts>
<![endif]-->

<!-- Comment -->



<!-- katex -->
<!--<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet">-->

<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">



</head>
<body>
    <div id="fh5co-offcanvas">
    <a href="#!" class="fh5co-close-offcanvas js-fh5co-close-offcanvas">
        <span><i class="icon-cross3"></i> <span>Close</span></span>
    </a>
    <div class="fh5co-bio">
        <figure>
            <img src="https://x1hy9.github.io/images/avatar.png" alt="Gridea"
                 class="img-responsive">
        </figure>
        <a href="https://x1hy9.github.io/post/about/"><h3 class="heading">ABOUT ME</h3></a>
        <h2>Gridea</h2>
        <p>温故而知新</p>
        <ul class="fh5co-social">
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
                <li>
                    
                </li>
            
        </ul>
    </div>

    <div class="fh5co-menu">

        <!-- 标签 -->
        <div class="fh5co-box">
            <a href="https://x1hy9.github.io/tags/"><h3 class="heading">👉标签</h3></a>
            <ul>
                
            </ul>
        </div>
    </div>
</div>

<header id="fh5co-header">
    <div class="container-fluid">
        <div class="row">
            <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle"><i></i></a>
            <ul class="fh5co-social">
                
                    <li>
                        <a href="/"
                        
                        >
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives"
                        
                        >
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags"
                        
                        >
                            标签
                        </a>
                    </li>
                
                    <li>
                        <a href="/post/about"
                        
                        >
                            关于
                        </a>
                    </li>
                
            </ul>
            <div class="col-lg-12 col-md-12 text-center">
                <h1 id="fh5co-logo">
                    <a href="https://x1hy9.github.io">Gridea </a>
                </h1>
            </div>
        </div>
    </div>
</header>


    <!--  <a href="#" class="fh5co-post-prev"><span>👈 Prev</span></a>-->
    <!--  <a href="#" class="fh5co-post-next"><span>Next 👉</span></a>-->

    <!-- 等gridea出自定义页面功能再优化一下 -->
    
        <div class="container-fluid">
    <div class="row fh5co-post-entry single-entry">
        <article class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-8 col-sm-offset-2 col-xs-12 col-xs-offset-0">
            <figure class="animate-box">
                
                    <img src="https://x1hy9.github.io/post-images/nei-wang-ji-ben-zhi-shi-dian-zong-jie.jpg" alt="内网基本知识点总结" class="img-responsive">
                
            </figure>
            <span class="fh5co-meta animate-box">
                
            </span>
            <h2 class="fh5co-article-title animate-box">内网基本知识点总结</h2>
            <ol class="breadcrumb fh5co-meta fh5co-date animate-box" style="margin-bottom:0; background-color:#f8f9fa">
                <li>2021-02-15</li>
                <li>1953字</li>
                <li>8 min read</li>
            </ol>

            <div class="col-lg-12 col-lg-offset-0 col-md-12 col-md-offset-0 col-sm-12 col-sm-offset-0 col-xs-12 col-xs-offset-0 text-left content-article">
                <div class="row">
                    <div class="col-md-12 animate-box post-content">
                        <p> <h2 id="ad活动目录-dc指域控制器">AD（活动目录） DC（指域控制器）</h2>
<p>相当于一个组件具有以下功能</p>
<ul>
<li>服务器及客户端计算机管理</li>
<li>用户服务</li>
<li>资源管理</li>
<li>桌面配置</li>
<li>应用系统支撑</li>
</ul>
<h3 id="攻击ad">攻击AD</h3>
<ul>
<li>利用常规Web渗透进行横向渗透</li>
<li>常规Dump Hash后进行PTH，循环操作，直到获取Domain Admins</li>
<li>利用SYSVOL和组策略首选项(GPP)</li>
<li>MS14-068</li>
<li>利用VSS卷影副本拷贝ntds.dit</li>
<li>利用Responder等工具进行ARP</li>
<li>Netbios和LLMNR命名投毒</li>
<li>kerberoast(破解Ticket)</li>
<li>MS17-010</li>
</ul>
<h2 id="kerberos协议">Kerberos协议</h2>
<p>用来认证的一种协议<br>
有以下四种</p>
<h3 id="协议内容">协议内容</h3>
<ul>
<li>AS：认证服务器</li>
<li>KDC：密钥分发中心</li>
<li>TGT：票据授权票据，票据的票据</li>
<li>TGS：票据授权服务器</li>
</ul>
<h3 id="认证过程">认证过程</h3>
<ul>
<li>用户先向KDC(是一种认证服务一般安装在域控中)发送请求验证自己是域内的机器</li>
<li>KDC确认用户并向用户发送凭证</li>
<li>用户向KDC发送网络服务访问请求凭证</li>
<li>KDC给用户发送网络服务访问凭证</li>
<li>用户使用网络服务凭证访问相应的网络服务</li>
<li>网络服务器确认网络服务凭证有效并向用户提供网络服务</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://x1hy9.oss-cn-beijing.aliyuncs.com/img/20210215180336.png" alt="" loading="lazy"></figure>
<p>有两种攻击方式</p>
<h3 id="黄金票据">黄金票据</h3>
<p>这种是通过直接伪造身份认证直接跳过3，4认证，相当于直接伪造TGT<br>
每个用户的Ticket都是由krbtgt的密码Hash来生成的，那么，我们如果拿到了krbtgt的密码Hash，其实就可以伪造任意用户的TICKET<br>
不过需要和dc交互</p>
<pre><code>1、域名称            
2、域的SID值
3、域的KRBTGT账户密码HASH
4、伪造用户名，可以是任意的
</code></pre>
<h3 id="白银票据">白银票据</h3>
<p>这种是通过直接伪造服务认证直接跳过5认证，因为在TGT已经在PAC里限定了给Client授权的服务（通过SID的值），所以银票只能访问指定服务</p>
<pre><code>1.域名称
2.域的SID值
3.域中的Server服务器账户的NTLM-Hash
4.伪造的用户名，可以是任意用户名.
5.目标服务器上面的kerberos服务
</code></pre>
<h2 id="ntlm协议">NTLM协议</h2>
<p>域渗透涉及到的技术，如哈希传递（PTH）票据传递（PTT）委派攻击等，都是基于域环境下的认证机制来实现的，这也是为什么要了解Windows认证机制的原因之一<br>
NTML分为两种认证一种是本地认证一种是网络认证</p>
<h3 id="本地认证">本地认证</h3>
<p>系统收到输入的密码进行如下操作</p>
<pre><code>用户密码-&gt;HEX编码-&gt;Unicode编码-&gt;MD4
</code></pre>
<p>然后与sam数据库（%SystemRoot%\system32\config\sam）中该用户的哈希比对，匹配则登陆成功，不匹配则登陆失败<br>
本地认证中用来处理用户输入密码的进程即lsass.exe,密码会在这个进程中明文保存，供该进程将密码计算成NTLM Hash与sam进行比对<br>
在渗透测试中，通常可从Windows系统中的SAM文件和域控的NTDS.dit文件中获得所有用户的hash，通过Mimikatz读取lsass.exe进程能获得已登录用户的NTLM hash</p>
<h3 id="网络认证">网络认证</h3>
<p>Net NTLM的认证过程分为三步，也叫挑战响应机制：</p>
<ol>
<li>协商</li>
<li>挑战</li>
<li>验证</li>
</ol>
<p>协商：主要用于确认双方协议版本、加密等级等。<br>
挑战：服务器在收到客户端的协商消息之后， 会读取其中的内容，并从中选择出自己所能接受的服务内容，加密等级，安全服务等等。 并生成一个随机数challenge, 然后生成challenge消息返回给客户端。该消息就是挑战/响应认证机制的主要功能体现。<br>
认证：验证主要是在挑战完成后，验证结果，是认证的最后一步。详细过程如下：</p>
<p>第一步,输入密码,然后LSASS会把密码的NTLM Hash后的值先存储到本地。<br>
第二步,客户端把用户名的明文发送给服务端<br>
第三步,服务端会生成一个16位的随机数,即challenge,再传回给客户端<br>
第四步,当客户端收到challenge后,用在第一步中存储的NTLM Hash对其加密，然后再将加密后的challenge发送给服务器，也就是response。<br>
第五步,服务端在收到response后，会向DC发送针对客户端的验证请求。该请求主要包含以下三方面的内容：客户端用户名、客户端NTLM Hash加密的Challenge、原始的Challenge。<br>
第六步,当DC接到过来的这三个值的以后,会根据用户名到DC的账号数据库(ntds.dit)里面找到该用户名对应的NTLM Hash,然后把这个hash拿出来和传过来的challenge值进行比较,相同则认证成功,反之,则失败。</p>
<p>针对ntml的攻击方式有一种叫做pth（哈希传递攻击）<br>
因为有些系统中密码不是以明文形式存在的 但是我们可以抓取到ntlm hash<br>
这样的话我们就可以通过返回的challenge用我们抓到的hash对其加密从而达到一种不用明文就可通过认证的目的<br>
Pass The Hash能够完成一个不需要输入密码的NTLM协议认证流程，所以不算是一个漏洞，算是一个技巧。常用的pth的工具主要有:mimikatz<br>
当然，pth也是有利用条件的。如果目标机器安装了KB2871997，那我们就不能pth了。那我们还有另一个姿势：PassTheKey。对于8.1/2012r2，<strong>安装补丁kb2871997</strong>的Win7/2008r2/8/2012，可以使用AES keys代替NTLM Hash。在mimikatz抓hash时，可以一并抓到。其实，mimikatz中的pth本身就是ptk了。命令：mimikatz &quot;privilege::debug&quot;&quot;sekurlsa::pth /user:a /domain:test.local /aes256:f74b379b5b422819db694aaf78f49177ed21c98ddad6b0e246a7e17df6d19d5c&quot; 除这些外，还有很多其他姿势，比如打了补丁有administrator帐号扔可pth、当开启Restricted Admin Mode后，win8.1和server12 R2默认支持pth、启用WDigest劫持winlogon仙人跳等</p>
<h2 id="windows-access-token">Windows Access Token</h2>
<p>Windows Access Token(访问令牌)，它是一个描述进程或者线程安全上下文的一个对象。不同的用户登录计算机后， 都会生成一个Access Token，这个Token在用户创建进程或者线程时会被使用，不断的拷贝，这也就解释了A用户创建一个进程而该进程没有B用户的权限。当用户注销后，系统将会使主令牌切换为模拟令牌，不会将令牌清 除，只有在重启机器后才会清除 Access Token分为两种(主令牌、模拟令牌)</p>
<h1 id="横向移动">横向移动</h1>
<h2 id="smb">SMB</h2>
<p>smb也是一种协议，只不过这种协议是用来文件共享的一般都是通过445or139端口实现使内网上的机器能共享文件，打印机，串行端口和通讯等资源</p>
<h2 id="ipc">IPC</h2>
<p>ipc也是基于SMB协议的一种特殊共享，是进程之间通过命名管道的通信<br>
因为没有密码错误限制所以可以批量爆破域内机器<br>
有些情况内网有些机器不会开3389导致你无法连上的时候你可以通过<br>
ipc复制木马到目标机上运行<br>
常用命令有</p>
<pre><code>0.建立空连接
net use \\192.168.1.1\ipc$ &quot;&quot; /u:&quot;&quot;
1.建立正常连接
net use \\192.168.1.1\ipc$ &quot;1qaz@WSX&quot; /user:&quot;Administrator&quot; 
2.查看本机连接共享情况
net use
3.查看已建立连接目标主机的共享资源
net view \\192.168.1.1
</code></pre>
<h2 id="wmi">WMI</h2>
<p>wmi是windows中由一组工具几何组成，用来管理本地或者远程管理windwos系统的<br>
使用wmi进行攻击windows系统不会在日志中记录这些操作<br>
利用条件是135没过滤</p>
 </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 animate-box">
                        
                    </div>
                </div>

                <div class="row">
    <div class="col-md-12 animate-box">
        
    </div>
</div>

            </div>

        </article>
    </div>
</div>

    

    <!-- 返回顶部 -->
    <div class="back-to-top">
    
        <a href="#!" id="tool-toc" class="hidden-xs hidden-sm">
            <i class="fa fa-map"></i>
        </a>
        <br>
    
    <a href="#top" class="hidden-xs hidden-sm"><i class="fa fa-paper-plane"></i></a>
</div>

<div class="post-toc animated fadeInRight hidden-xs hidden-sm" style="display: none;">
    <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#ad%E6%B4%BB%E5%8A%A8%E7%9B%AE%E5%BD%95-dc%E6%8C%87%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8">AD（活动目录） DC（指域控制器）</a>
<ul>
<li><a href="#%E6%94%BB%E5%87%BBad">攻击AD</a></li>
</ul>
</li>
<li><a href="#kerberos%E5%8D%8F%E8%AE%AE">Kerberos协议</a>
<ul>
<li><a href="#%E5%8D%8F%E8%AE%AE%E5%86%85%E5%AE%B9">协议内容</a></li>
<li><a href="#%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B">认证过程</a></li>
<li><a href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE">黄金票据</a></li>
<li><a href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE">白银票据</a></li>
</ul>
</li>
<li><a href="#ntlm%E5%8D%8F%E8%AE%AE">NTLM协议</a>
<ul>
<li><a href="#%E6%9C%AC%E5%9C%B0%E8%AE%A4%E8%AF%81">本地认证</a></li>
<li><a href="#%E7%BD%91%E7%BB%9C%E8%AE%A4%E8%AF%81">网络认证</a></li>
</ul>
</li>
<li><a href="#windows-access-token">Windows Access Token</a></li>
</ul>
</li>
<li><a href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8">横向移动</a>
<ul>
<li><a href="#smb">SMB</a></li>
<li><a href="#ipc">IPC</a></li>
<li><a href="#wmi">WMI</a></li>
</ul>
</li>
</ul>

</div>


    
<footer id="fh5co-footer">
  <p>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a></p>
</footer>


    <!-- jQuery -->
<script src="https://x1hy9.github.io/media/scripts/jquery.min.js"></script>
<!-- img lazy load -->
<script src="https://x1hy9.github.io/media/scripts/jquery.lazyload.min.js"></script>
<!-- jQuery Easing -->
<script src="https://x1hy9.github.io/media/scripts/jquery.easing.1.3.js"></script>
<!-- Bootstrap -->
<script src="https://x1hy9.github.io/media/scripts/bootstrap.min.js"></script>
<!-- Waypoints -->
<script src="https://x1hy9.github.io/media/scripts/jquery.waypoints.min.js"></script>
<!-- Main JS -->
<script src="https://x1hy9.github.io/media/scripts/main.js"></script>
<!-- Md5 Min JS -->
<script src="https://x1hy9.github.io/media/scripts/md5.min.js"></script>
<!-- katex -->
<!--<script src="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.js"></script>-->
<!-- highlight -->
<script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>


<script type="application/javascript">
    // 代码高亮
    hljs.initHighlightingOnLoad();

    // img 懒加载
    $(function () {
        $("img.lazy").lazyload({
            effect: "fadeIn",  // 懒加载动画
            threshold: 180  // 在图片距离屏幕180px时提前载入
        });
        // tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // 目录
        $('#tool-toc').click(function () {
            $('.post-toc').toggle();
        });
    });

    
</script>




</body>
</html>
